(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[3494],{7925:(e,t,n)=>{"use strict";n.r(t),n.d(t,{assets:()=>v,contentTitle:()=>p,default:()=>b,frontMatter:()=>h,metadata:()=>g,toc:()=>f});var r=n(74848),o=n(28453),i=n(78847),s=n(64428),a=n(5131),c=n.n(a),l=n(18120),d=n.n(l),m=n(75183),u=n.n(m);const h={sidebar_class_name:"hidden",pagination_prev:null,pagination_next:null},p="How to do retrieval with contextual compression",g={id:"how_to/contextual_compression",title:"How to do retrieval with contextual compression",description:"This guide assumes familiarity with the following concepts:",source:"@site/docs/how_to/contextual_compression.mdx",sourceDirName:"how_to",slug:"/how_to/contextual_compression",permalink:"/docs/how_to/contextual_compression",draft:!1,unlisted:!1,editUrl:"https://langchainjs-kr.site/docs/how_to/contextual_compression.mdx",tags:[],version:"current",frontMatter:{sidebar_class_name:"hidden",pagination_prev:null,pagination_next:null},sidebar:"tutorialSidebar"},v={},f=[{value:"Using a vanilla vector store retriever",id:"using-a-vanilla-vector-store-retriever",level:2},...i.toc,{value:"<code>EmbeddingsFilter</code>",id:"embeddingsfilter",level:2},{value:"Stringing compressors and document transformers together",id:"stringing-compressors-and-document-transformers-together",level:2},{value:"Next steps",id:"next-steps",level:2}];function x(e){const t={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",li:"li",p:"p",pre:"pre",ul:"ul",...(0,o.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(t.h1,{id:"how-to-do-retrieval-with-contextual-compression",children:"How to do retrieval with contextual compression"}),"\n",(0,r.jsxs)(t.admonition,{title:"Prerequisites",type:"info",children:[(0,r.jsx)(t.p,{children:"This guide assumes familiarity with the following concepts:"}),(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"/docs/concepts/#retrievers",children:"Retrievers"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"/docs/tutorials/rag",children:"Retrieval-augmented generation (RAG)"})}),"\n"]})]}),"\n",(0,r.jsx)(t.p,{children:"One challenge with retrieval is that usually you don't know the specific queries your document storage system will face when you ingest data into the system. This means that the information most relevant to a query may be buried in a document with a lot of irrelevant text. Passing that full document through your application can lead to more expensive LLM calls and poorer responses."}),"\n",(0,r.jsx)(t.p,{children:"Contextual compression is meant to fix this. The idea is simple: instead of immediately returning retrieved documents as-is, you can compress them using the context of the given query, so that only the relevant information is returned. \u201cCompressing\u201d here refers to both compressing the contents of an individual document and filtering out documents wholesale."}),"\n",(0,r.jsx)(t.p,{children:"To use the Contextual Compression Retriever, you'll need:"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:"a base retriever"}),"\n",(0,r.jsx)(t.li,{children:"a Document Compressor"}),"\n"]}),"\n",(0,r.jsx)(t.p,{children:"The Contextual Compression Retriever passes queries to the base retriever, takes the initial documents and passes them through the Document Compressor. The Document Compressor takes a list of documents and shortens it by reducing the contents of documents or dropping documents altogether."}),"\n",(0,r.jsx)(t.h2,{id:"using-a-vanilla-vector-store-retriever",children:"Using a vanilla vector store retriever"}),"\n",(0,r.jsxs)(t.p,{children:["Let's start by initializing a simple vector store retriever and storing the 2023 State of the Union speech (in chunks).\nGiven an example question, our retriever returns one or two relevant docs and a few irrelevant docs, and even the relevant docs have a lot of irrelevant information in them.\nTo extract all the context we can, we use an ",(0,r.jsx)(t.code,{children:"LLMChainExtractor"}),", which will iterate over the initially returned documents and extract from each only the content that is relevant to the query."]}),"\n","\n",(0,r.jsx)(i.default,{}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-bash",metastring:"npm2yarn",children:"npm install @langchain/openai @langchain/community\n"})}),"\n","\n",(0,r.jsx)(s.A,{language:"typescript",children:c()}),"\n",(0,r.jsx)(t.h2,{id:"embeddingsfilter",children:(0,r.jsx)(t.code,{children:"EmbeddingsFilter"})}),"\n",(0,r.jsxs)(t.p,{children:["Making an extra LLM call over each retrieved document is expensive and slow. The ",(0,r.jsx)(t.code,{children:"EmbeddingsFilter"})," provides a cheaper and faster option by embedding the documents and query and only returning those documents which have sufficiently similar embeddings to the query."]}),"\n",(0,r.jsx)(t.p,{children:"This is most useful for non-vector store retrievers where we may not have control over the returned chunk size, or as part of a pipeline, outlined below."}),"\n",(0,r.jsx)(t.p,{children:"Here's an example:"}),"\n","\n",(0,r.jsx)(s.A,{language:"typescript",children:d()}),"\n",(0,r.jsx)(t.h2,{id:"stringing-compressors-and-document-transformers-together",children:"Stringing compressors and document transformers together"}),"\n",(0,r.jsxs)(t.p,{children:["Using the ",(0,r.jsx)(t.code,{children:"DocumentCompressorPipeline"})," we can also easily combine multiple compressors in sequence. Along with compressors we can add BaseDocumentTransformers to our pipeline, which don't perform any contextual compression but simply perform some transformation on a set of documents.\nFor example ",(0,r.jsx)(t.code,{children:"TextSplitters"})," can be used as document transformers to split documents into smaller pieces, and the ",(0,r.jsx)(t.code,{children:"EmbeddingsFilter"})," can be used to filter out documents based on similarity of the individual chunks to the input query."]}),"\n",(0,r.jsxs)(t.p,{children:["Below we create a compressor pipeline by first splitting raw webpage documents retrieved from the ",(0,r.jsx)(t.a,{href:"/docs/integrations/retrievers/tavily",children:"Tavily web search API retriever"})," into smaller chunks, then filtering based on relevance to the query.\nThe result is smaller chunks that are semantically similar to the input query.\nThis skips the need to add documents to a vector store to perform similarity search, which can be useful for one-off use cases:"]}),"\n","\n",(0,r.jsx)(s.A,{language:"typescript",children:u()}),"\n",(0,r.jsx)(t.h2,{id:"next-steps",children:"Next steps"}),"\n",(0,r.jsx)(t.p,{children:"You've now learned a few ways to use contextual compression to remove bad data from your results."}),"\n",(0,r.jsxs)(t.p,{children:["See the individual sections for deeper dives on specific retrievers, the ",(0,r.jsx)(t.a,{href:"/docs/tutorials/rag",children:"broader tutorial on RAG"}),", or this section to learn how to\n",(0,r.jsx)(t.a,{href:"/docs/how_to/custom_retriever/",children:"create your own custom retriever over any data source"}),"."]})]})}function b(e={}){const{wrapper:t}={...(0,o.R)(),...e.components};return t?(0,r.jsx)(t,{...e,children:(0,r.jsx)(x,{...e})}):x(e)}},5131:e=>{e.exports={content:'import * as fs from "fs";\n\nimport { OpenAI, OpenAIEmbeddings } from "@langchain/openai";\nimport { RecursiveCharacterTextSplitter } from "@langchain/textsplitters";\nimport { HNSWLib } from "@langchain/community/vectorstores/hnswlib";\nimport { ContextualCompressionRetriever } from "langchain/retrievers/contextual_compression";\nimport { LLMChainExtractor } from "langchain/retrievers/document_compressors/chain_extract";\n\nconst model = new OpenAI({\n  model: "gpt-3.5-turbo-instruct",\n});\nconst baseCompressor = LLMChainExtractor.fromLLM(model);\n\nconst text = fs.readFileSync("state_of_the_union.txt", "utf8");\n\nconst textSplitter = new RecursiveCharacterTextSplitter({ chunkSize: 1000 });\nconst docs = await textSplitter.createDocuments([text]);\n\n// Create a vector store from the documents.\nconst vectorStore = await HNSWLib.fromDocuments(docs, new OpenAIEmbeddings());\n\nconst retriever = new ContextualCompressionRetriever({\n  baseCompressor,\n  baseRetriever: vectorStore.asRetriever(),\n});\n\nconst retrievedDocs = await retriever.invoke(\n  "What did the speaker say about Justice Breyer?"\n);\n\nconsole.log({ retrievedDocs });\n\n/*\n  {\n    retrievedDocs: [\n      Document {\n        pageContent: \'One of our nation\u2019s top legal minds, who will continue Justice Breyer\u2019s legacy of excellence.\',\n        metadata: [Object]\n      },\n      Document {\n        pageContent: \'"Tonight, I\u2019d like to honor someone who has dedicated his life to serve this country: Justice Stephen Breyer\u2014an Army veteran, Constitutional scholar, and retiring Justice of the United States Supreme Court. Justice Breyer, thank you for your service."\',\n        metadata: [Object]\n      },\n      Document {\n        pageContent: \'The onslaught of state laws targeting transgender Americans and their families is wrong.\',\n        metadata: [Object]\n      }\n    ]\n  }\n*/\n',imports:[{local:"OpenAI",imported:"OpenAI",source:"@langchain/openai"},{local:"OpenAIEmbeddings",imported:"OpenAIEmbeddings",source:"@langchain/openai"},{local:"RecursiveCharacterTextSplitter",imported:"RecursiveCharacterTextSplitter",source:"@langchain/textsplitters"},{local:"HNSWLib",imported:"HNSWLib",source:"@langchain/community/vectorstores/hnswlib"},{local:"ContextualCompressionRetriever",imported:"ContextualCompressionRetriever",source:"langchain/retrievers/contextual_compression"},{local:"LLMChainExtractor",imported:"LLMChainExtractor",source:"langchain/retrievers/document_compressors/chain_extract"}]}},75183:e=>{e.exports={content:'import { RecursiveCharacterTextSplitter } from "@langchain/textsplitters";\nimport { OpenAIEmbeddings } from "@langchain/openai";\nimport { ContextualCompressionRetriever } from "langchain/retrievers/contextual_compression";\nimport { EmbeddingsFilter } from "langchain/retrievers/document_compressors/embeddings_filter";\nimport { TavilySearchAPIRetriever } from "@langchain/community/retrievers/tavily_search_api";\nimport { DocumentCompressorPipeline } from "langchain/retrievers/document_compressors";\n\nconst embeddingsFilter = new EmbeddingsFilter({\n  embeddings: new OpenAIEmbeddings(),\n  similarityThreshold: 0.8,\n  k: 5,\n});\n\nconst textSplitter = new RecursiveCharacterTextSplitter({\n  chunkSize: 200,\n  chunkOverlap: 0,\n});\n\nconst compressorPipeline = new DocumentCompressorPipeline({\n  transformers: [textSplitter, embeddingsFilter],\n});\n\nconst baseRetriever = new TavilySearchAPIRetriever({\n  includeRawContent: true,\n});\n\nconst retriever = new ContextualCompressionRetriever({\n  baseCompressor: compressorPipeline,\n  baseRetriever,\n});\n\nconst retrievedDocs = await retriever.invoke(\n  "What did the speaker say about Justice Breyer in the 2022 State of the Union?"\n);\nconsole.log({ retrievedDocs });\n\n/*\n  {\n    retrievedDocs: [\n      Document {\n        pageContent: \'Justice Stephen Breyer talks to President Joe Biden ahead of the State of the Union address on Tuesday. (jabin botsford/Agence France-Presse/Getty Images)\',\n        metadata: [Object]\n      },\n      Document {\n        pageContent: \'President Biden recognized outgoing US Supreme Court Justice Stephen Breyer during his State of the Union on Tuesday.\',\n        metadata: [Object]\n      },\n      Document {\n        pageContent: \'What we covered here\\n\' +\n          \'Biden recognized outgoing Supreme Court Justice Breyer during his speech\',\n        metadata: [Object]\n      },\n      Document {\n        pageContent: \'States Supreme Court. Justice Breyer, thank you for your service,\u201d the president said.\',\n        metadata: [Object]\n      },\n      Document {\n        pageContent: \'Court," Biden said. "Justice Breyer, thank you for your service."\',\n        metadata: [Object]\n      }\n    ]\n  }\n*/\n',imports:[{local:"RecursiveCharacterTextSplitter",imported:"RecursiveCharacterTextSplitter",source:"@langchain/textsplitters"},{local:"OpenAIEmbeddings",imported:"OpenAIEmbeddings",source:"@langchain/openai"},{local:"ContextualCompressionRetriever",imported:"ContextualCompressionRetriever",source:"langchain/retrievers/contextual_compression"},{local:"EmbeddingsFilter",imported:"EmbeddingsFilter",source:"langchain/retrievers/document_compressors/embeddings_filter"},{local:"TavilySearchAPIRetriever",imported:"TavilySearchAPIRetriever",source:"@langchain/community/retrievers/tavily_search_api"},{local:"DocumentCompressorPipeline",imported:"DocumentCompressorPipeline",source:"langchain/retrievers/document_compressors"}]}},18120:e=>{e.exports={content:"import * as fs from \"fs\";\n\nimport { RecursiveCharacterTextSplitter } from \"@langchain/textsplitters\";\nimport { HNSWLib } from \"@langchain/community/vectorstores/hnswlib\";\nimport { OpenAIEmbeddings } from \"@langchain/openai\";\nimport { ContextualCompressionRetriever } from \"langchain/retrievers/contextual_compression\";\nimport { EmbeddingsFilter } from \"langchain/retrievers/document_compressors/embeddings_filter\";\n\nconst baseCompressor = new EmbeddingsFilter({\n  embeddings: new OpenAIEmbeddings(),\n  similarityThreshold: 0.8,\n});\n\nconst text = fs.readFileSync(\"state_of_the_union.txt\", \"utf8\");\n\nconst textSplitter = new RecursiveCharacterTextSplitter({ chunkSize: 1000 });\nconst docs = await textSplitter.createDocuments([text]);\n\n// Create a vector store from the documents.\nconst vectorStore = await HNSWLib.fromDocuments(docs, new OpenAIEmbeddings());\n\nconst retriever = new ContextualCompressionRetriever({\n  baseCompressor,\n  baseRetriever: vectorStore.asRetriever(),\n});\n\nconst retrievedDocs = await retriever.invoke(\n  \"What did the speaker say about Justice Breyer?\"\n);\nconsole.log({ retrievedDocs });\n\n/*\n  {\n    retrievedDocs: [\n      Document {\n        pageContent: 'And I did that 4 days ago, when I nominated Circuit Court of Appeals Judge Ketanji Brown Jackson. One of our nation\u2019s top legal minds, who will continue Justice Breyer\u2019s legacy of excellence. \\n' +\n          '\\n' +\n          'A former top litigator in private practice. A former federal public defender. And from a family of public school educators and police officers. A consensus builder. Since she\u2019s been nominated, she\u2019s received a broad range of support\u2014from the Fraternal Order of Police to former judges appointed by Democrats and Republicans. \\n' +\n          '\\n' +\n          'And if we are to advance liberty and justice, we need to secure the Border and fix the immigration system. \\n' +\n          '\\n' +\n          'We can do both. At our border, we\u2019ve installed new technology like cutting-edge scanners to better detect drug smuggling.  \\n' +\n          '\\n' +\n          'We\u2019ve set up joint patrols with Mexico and Guatemala to catch more human traffickers.  \\n' +\n          '\\n' +\n          'We\u2019re putting in place dedicated immigration judges so families fleeing persecution and violence can have their cases heard faster.',\n        metadata: [Object]\n      },\n      Document {\n        pageContent: 'In state after state, new laws have been passed, not only to suppress the vote, but to subvert entire elections. \\n' +\n          '\\n' +\n          'We cannot let this happen. \\n' +\n          '\\n' +\n          'Tonight. I call on the Senate to: Pass the Freedom to Vote Act. Pass the John Lewis Voting Rights Act. And while you\u2019re at it, pass the Disclose Act so Americans can know who is funding our elections. \\n' +\n          '\\n' +\n          'Tonight, I\u2019d like to honor someone who has dedicated his life to serve this country: Justice Stephen Breyer\u2014an Army veteran, Constitutional scholar, and retiring Justice of the United States Supreme Court. Justice Breyer, thank you for your service. \\n' +\n          '\\n' +\n          'One of the most serious constitutional responsibilities a President has is nominating someone to serve on the United States Supreme Court. \\n' +\n          '\\n' +\n          'And I did that 4 days ago, when I nominated Circuit Court of Appeals Judge Ketanji Brown Jackson. One of our nation\u2019s top legal minds, who will continue Justice Breyer\u2019s legacy of excellence.',\n        metadata: [Object]\n      }\n    ]\n  }\n*/\n",imports:[{local:"RecursiveCharacterTextSplitter",imported:"RecursiveCharacterTextSplitter",source:"@langchain/textsplitters"},{local:"HNSWLib",imported:"HNSWLib",source:"@langchain/community/vectorstores/hnswlib"},{local:"OpenAIEmbeddings",imported:"OpenAIEmbeddings",source:"@langchain/openai"},{local:"ContextualCompressionRetriever",imported:"ContextualCompressionRetriever",source:"langchain/retrievers/contextual_compression"},{local:"EmbeddingsFilter",imported:"EmbeddingsFilter",source:"langchain/retrievers/document_compressors/embeddings_filter"}]}}}]);