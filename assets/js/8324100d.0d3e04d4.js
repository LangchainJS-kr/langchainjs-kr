(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[6789],{11048:(e,n,r)=>{"use strict";r.r(n),r.d(n,{assets:()=>d,contentTitle:()=>u,default:()=>f,frontMatter:()=>c,metadata:()=>p,toc:()=>m});var t=r(74848),a=r(28453),o=r(64428),s=r(78847),i=r(43770),l=r.n(i);const c={hide_table_of_contents:!0},u="Cloudflare D1-Backed Chat Memory",p={id:"integrations/chat_memory/cloudflare_d1",title:"Cloudflare D1-Backed Chat Memory",description:"This integration is only supported in Cloudflare Workers.",source:"@site/docs/integrations/chat_memory/cloudflare_d1.mdx",sourceDirName:"integrations/chat_memory",slug:"/integrations/chat_memory/cloudflare_d1",permalink:"/docs/integrations/chat_memory/cloudflare_d1",draft:!1,unlisted:!1,editUrl:"https://langchainjs-kr.site/docs/integrations/chat_memory/cloudflare_d1.mdx",tags:[],version:"current",frontMatter:{hide_table_of_contents:!0}},d={},m=[{value:"Setup",id:"setup",level:2},...s.toc,{value:"Usage",id:"usage",level:2}];function h(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",p:"p",pre:"pre",...(0,a.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h1,{id:"cloudflare-d1-backed-chat-memory",children:"Cloudflare D1-Backed Chat Memory"}),"\n",(0,t.jsx)(n.admonition,{type:"info",children:(0,t.jsx)(n.p,{children:"This integration is only supported in Cloudflare Workers."})}),"\n",(0,t.jsxs)(n.p,{children:["For longer-term persistence across chat sessions, you can swap out the default in-memory ",(0,t.jsx)(n.code,{children:"chatHistory"})," that backs chat memory classes like ",(0,t.jsx)(n.code,{children:"BufferMemory"})," for a Cloudflare D1 instance."]}),"\n",(0,t.jsx)(n.h2,{id:"setup",children:"Setup"}),"\n",(0,t.jsx)(n.p,{children:"You'll need to install the LangChain Cloudflare integration package.\nFor the below example, we also use Anthropic, but you can use any model you'd like:"}),"\n","\n",(0,t.jsx)(s.default,{}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",metastring:"npm2yarn",children:"npm install @langchain/cloudflare @langchain/anthropic\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Set up a D1 instance for your worker by following ",(0,t.jsx)(n.a,{href:"https://developers.cloudflare.com/d1/",children:"the official documentation"}),". Your project's ",(0,t.jsx)(n.code,{children:"wrangler.toml"})," file should\nlook something like this:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-toml",children:'name = "YOUR_PROJECT_NAME"\nmain = "src/index.ts"\ncompatibility_date = "2024-01-10"\n\n[vars]\nANTHROPIC_API_KEY = "YOUR_ANTHROPIC_KEY"\n\n[[d1_databases]]\nbinding = "DB"                                       # available in your Worker as env.DB\ndatabase_name = "YOUR_D1_DB_NAME"\ndatabase_id = "YOUR_D1_DB_ID"\n'})}),"\n",(0,t.jsx)(n.h2,{id:"usage",children:"Usage"}),"\n",(0,t.jsx)(n.p,{children:"You can then use D1 to store your history as follows:"}),"\n","\n",(0,t.jsx)(o.A,{language:"typescript",children:l()})]})}function f(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(h,{...e})}):h(e)}},43770:e=>{e.exports={content:'import type { D1Database } from "@cloudflare/workers-types";\nimport { BufferMemory } from "langchain/memory/index";\nimport { CloudflareD1MessageHistory } from "@langchain/cloudflare";\nimport {\n  ChatPromptTemplate,\n  MessagesPlaceholder,\n} from "@langchain/core/prompts";\nimport { RunnableSequence } from "@langchain/core/runnables";\nimport { StringOutputParser } from "@langchain/core/output_parsers";\nimport { ChatAnthropic } from "@langchain/anthropic";\n\nexport interface Env {\n  DB: D1Database;\n\n  ANTHROPIC_API_KEY: string;\n}\n\nexport default {\n  async fetch(request: Request, env: Env): Promise<Response> {\n    try {\n      const { searchParams } = new URL(request.url);\n      const input = searchParams.get("input");\n      if (!input) {\n        throw new Error(`Missing "input" parameter`);\n      }\n      const memory = new BufferMemory({\n        returnMessages: true,\n        chatHistory: new CloudflareD1MessageHistory({\n          tableName: "stored_message",\n          sessionId: "example",\n          database: env.DB,\n        }),\n      });\n      const prompt = ChatPromptTemplate.fromMessages([\n        ["system", "You are a helpful chatbot"],\n        new MessagesPlaceholder("history"),\n        ["human", "{input}"],\n      ]);\n      const model = new ChatAnthropic({\n        apiKey: env.ANTHROPIC_API_KEY,\n      });\n\n      const chain = RunnableSequence.from([\n        {\n          input: (initialInput) => initialInput.input,\n          memory: () => memory.loadMemoryVariables({}),\n        },\n        {\n          input: (previousOutput) => previousOutput.input,\n          history: (previousOutput) => previousOutput.memory.history,\n        },\n        prompt,\n        model,\n        new StringOutputParser(),\n      ]);\n\n      const chainInput = { input };\n\n      const res = await chain.invoke(chainInput);\n      await memory.saveContext(chainInput, {\n        output: res,\n      });\n\n      return new Response(JSON.stringify(res), {\n        headers: { "content-type": "application/json" },\n      });\n    } catch (err: any) {\n      console.log(err.message);\n      return new Response(err.message, { status: 500 });\n    }\n  },\n};\n',imports:[{local:"BufferMemory",imported:"BufferMemory",source:"langchain/memory/index"},{local:"CloudflareD1MessageHistory",imported:"CloudflareD1MessageHistory",source:"@langchain/cloudflare"},{local:"ChatPromptTemplate",imported:"ChatPromptTemplate",source:"@langchain/core/prompts"},{local:"MessagesPlaceholder",imported:"MessagesPlaceholder",source:"@langchain/core/prompts"},{local:"RunnableSequence",imported:"RunnableSequence",source:"@langchain/core/runnables"},{local:"StringOutputParser",imported:"StringOutputParser",source:"@langchain/core/output_parsers"},{local:"ChatAnthropic",imported:"ChatAnthropic",source:"@langchain/anthropic"}]}}}]);