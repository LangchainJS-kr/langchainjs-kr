"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[6771],{41155:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>h,contentTitle:()=>o,default:()=>d,frontMatter:()=>a,metadata:()=>r,toc:()=>c});var t=s(74848),i=s(28453);const a={sidebar_class_name:"hidden",pagination_prev:null,pagination_next:null},o="How to add message history",r={id:"how_to/message_history",title:"How to add message history",description:"This guide assumes familiarity with the following concepts:",source:"@site/docs/how_to/message_history.mdx",sourceDirName:"how_to",slug:"/how_to/message_history",permalink:"/docs/how_to/message_history",draft:!1,unlisted:!1,editUrl:"https://langchainjs-kr.site/docs/how_to/message_history.mdx",tags:[],version:"current",frontMatter:{sidebar_class_name:"hidden",pagination_prev:null,pagination_next:null},sidebar:"tutorialSidebar"},h={},c=[{value:"Setup",id:"setup",level:2},{value:"LangSmith",id:"langsmith",level:3},{value:"Adding message history",id:"adding-message-history",level:3},{value:"Invoking with config",id:"invoking-with-config",level:2}];function l(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",ul:"ul",...(0,i.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h1,{id:"how-to-add-message-history",children:"How to add message history"}),"\n",(0,t.jsxs)(n.admonition,{title:"Prerequisites",type:"info",children:[(0,t.jsx)(n.p,{children:"This guide assumes familiarity with the following concepts:"}),(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"/docs/concepts/#langchain-expression-language",children:"LangChain Expression Language (LCEL)"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"/docs/how_to/sequence/",children:"Chaining runnables"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"/docs/how_to/binding",children:"Configuring chain parameters at runtime"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"/docs/concepts/#prompt-templates",children:"Prompt templates"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"/docs/concepts/#message-types",children:"Chat Messages"})}),"\n"]})]}),"\n",(0,t.jsxs)(n.p,{children:["The ",(0,t.jsx)(n.code,{children:"RunnableWithMessageHistory"})," lets us add message history to certain types of chains."]}),"\n",(0,t.jsx)(n.p,{children:"Specifically, it can be used for any Runnable that takes as input one of"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["a sequence of ",(0,t.jsx)(n.a,{href:"/docs/concepts/#message-types",children:(0,t.jsx)(n.code,{children:"BaseMessages"})})]}),"\n",(0,t.jsxs)(n.li,{children:["a dict with a key that takes a sequence of ",(0,t.jsx)(n.code,{children:"BaseMessage"})]}),"\n",(0,t.jsxs)(n.li,{children:["a dict with a key that takes the latest message(s) as a string or sequence of ",(0,t.jsx)(n.code,{children:"BaseMessage"}),", and a separate key that takes historical messages"]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"And returns as output one of"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["a string that can be treated as the contents of an ",(0,t.jsx)(n.code,{children:"AIMessage"})]}),"\n",(0,t.jsxs)(n.li,{children:["a sequence of ",(0,t.jsx)(n.code,{children:"BaseMessage"})]}),"\n",(0,t.jsxs)(n.li,{children:["a dict with a key that contains a sequence of ",(0,t.jsx)(n.code,{children:"BaseMessage"})]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"Let's take a look at some examples to see how it works."}),"\n",(0,t.jsx)(n.h2,{id:"setup",children:"Setup"}),"\n",(0,t.jsx)(n.p,{children:"We'll use Upstash to store our chat message histories and Anthropic's claude-2 model so we'll need to install the following dependencies:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",metastring:"npm2yarn",children:"npm install @langchain/anthropic @langchain/community @upstash/redis\n"})}),"\n",(0,t.jsxs)(n.p,{children:["You'll need to set environment variables for ",(0,t.jsx)(n.code,{children:"ANTHROPIC_API_KEY"})," and grab your Upstash REST url and secret token."]}),"\n",(0,t.jsx)(n.h3,{id:"langsmith",children:(0,t.jsx)(n.a,{href:"https://smith.langchain.com/",children:"LangSmith"})}),"\n",(0,t.jsx)(n.p,{children:"LangSmith is especially useful for something like message history injection, where it can be hard to otherwise understand what the inputs are to various parts of the chain."}),"\n",(0,t.jsx)(n.p,{children:"Note that LangSmith is not needed, but it is helpful.\nIf you do want to use LangSmith, after you sign up at the link above, make sure to uncoment the below and set your environment variables to start logging traces:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'export LANGCHAIN_TRACING_V2="true"\nexport LANGCHAIN_API_KEY="<your-api-key>"\n'})}),"\n",(0,t.jsxs)(n.p,{children:["Let's create a simple runnable that takes a dict as input and returns a ",(0,t.jsx)(n.code,{children:"BaseMessage"}),"."]}),"\n",(0,t.jsxs)(n.p,{children:["In this case the ",(0,t.jsx)(n.code,{children:'"question"'})," key in the input represents our input message, and the ",(0,t.jsx)(n.code,{children:'"history"'})," key is where our historical messages will be injected."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:'import {\n  ChatPromptTemplate,\n  MessagesPlaceholder,\n} from "@langchain/core/prompts";\nimport { ChatAnthropic } from "@langchain/anthropic";\nimport { UpstashRedisChatMessageHistory } from "@langchain/community/stores/message/upstash_redis";\n// For demos, you can also use an in-memory store:\n// import { ChatMessageHistory } from "langchain/stores/message/in_memory";\n\nconst prompt = ChatPromptTemplate.fromMessages([\n  ["system", "You\'re an assistant who\'s good at {ability}"],\n  new MessagesPlaceholder("history"),\n  ["human", "{question}"],\n]);\n\nconst chain = prompt.pipe(\n  new ChatAnthropic({ model: "claude-3-sonnet-20240229" })\n);\n'})}),"\n",(0,t.jsx)(n.h3,{id:"adding-message-history",children:"Adding message history"}),"\n",(0,t.jsxs)(n.p,{children:["To add message history to our original chain we wrap it in the ",(0,t.jsx)(n.code,{children:"RunnableWithMessageHistory"})," class."]}),"\n",(0,t.jsxs)(n.p,{children:["Crucially, we also need to define a ",(0,t.jsx)(n.code,{children:"getMessageHistory()"})," method that takes a ",(0,t.jsx)(n.code,{children:"sessionId"})," string and based on it returns a ",(0,t.jsx)(n.code,{children:"BaseChatMessageHistory"}),". Given the same input, this method should return an equivalent output."]}),"\n",(0,t.jsxs)(n.p,{children:["In this case, we'll also want to specify ",(0,t.jsx)(n.code,{children:"inputMessagesKey"})," (the key to be treated as the latest input message) and ",(0,t.jsx)(n.code,{children:"historyMessagesKey"})," (the key to add historical messages to)."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:'import { RunnableWithMessageHistory } from "@langchain/core/runnables";\n\nconst chainWithHistory = new RunnableWithMessageHistory({\n  runnable: chain,\n  getMessageHistory: (sessionId) =>\n    new UpstashRedisChatMessageHistory({\n      sessionId,\n      config: {\n        url: process.env.UPSTASH_REDIS_REST_URL!,\n        token: process.env.UPSTASH_REDIS_REST_TOKEN!,\n      },\n    }),\n  inputMessagesKey: "question",\n  historyMessagesKey: "history",\n});\n'})}),"\n",(0,t.jsx)(n.h2,{id:"invoking-with-config",children:"Invoking with config"}),"\n",(0,t.jsxs)(n.p,{children:["Whenever we call our chain with message history, we need to include an additional config object that contains the ",(0,t.jsx)(n.code,{children:"session_id"})]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:'{\n  configurable: {\n    sessionId: "<SESSION_ID>";\n  }\n}\n'})}),"\n",(0,t.jsx)(n.p,{children:"Given the same configuration, our chain should be pulling from the same chat message history."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"const result = await chainWithHistory.invoke(\n  {\n    ability: \"math\",\n    question: \"What does cosine mean?\",\n  },\n  {\n    configurable: {\n      sessionId: \"foobarbaz\",\n    },\n  }\n);\n\nconsole.log(result);\n\n/*\n  AIMessage {\n    content: 'Cosine refers to one of the basic trigonometric functions. Specifically:\\n' +\n      '\\n' +\n      '- Cosine is one of the three main trigonometric functions, along with sine and tangent. It is often abbreviated as cos.\\n' +\n      '\\n' +\n      '- For a right triangle with sides a, b, and c (where c is the hypotenuse), cosine represents the ratio of the length of the adjacent side (a) to the length of the hypotenuse (c). So cos(A) = a/c, where A is the angle opposite side a.\\n' +\n      '\\n' +\n      '- On the Cartesian plane, cosine represents the x-coordinate of a point on the unit circle for a given angle. So if you take an angle \u03b8 on the unit circle, the cosine of \u03b8 gives you the x-coordinate of where the terminal side of that angle intersects the circle.\\n' +\n      '\\n' +\n      '- The cosine function has a periodic waveform that oscillates between 1 and -1. Its graph forms a cosine wave.\\n' +\n      '\\n' +\n      'So in essence, cosine helps relate an angle in a right triangle to the ratio of two of its sides. Along with sine and tangent, it is foundational to trigonometry and mathematical modeling of periodic functions.',\n    name: undefined,\n    additional_kwargs: {\n      id: 'msg_01QnnAkKEz7WvhJrwLWGbLBm',\n      type: 'message',\n      role: 'assistant',\n      model: 'claude-3-sonnet-20240229',\n      stop_reason: 'end_turn',\n      stop_sequence: null\n    }\n  }\n*/\n\nconst result2 = await chainWithHistory.invoke(\n  {\n    ability: \"math\",\n    question: \"What's its inverse?\",\n  },\n  {\n    configurable: {\n      sessionId: \"foobarbaz\",\n    },\n  }\n);\n\nconsole.log(result2);\n\n/*\n  AIMessage {\n    content: 'The inverse of the cosine function is the arcsine or inverse sine function, often written as sin\u22121(x) or sin^{-1}(x).\\n' +\n      '\\n' +\n      'Some key properties of the inverse cosine function:\\n' +\n      '\\n' +\n      '- It accepts values between -1 and 1 as inputs and returns angles from 0 to \u03c0 radians (0 to 180 degrees). This is the inverse of the regular cosine function, which takes angles and returns the cosine ratio.\\n' +\n      '\\n' +\n      '- It is also called cos\u22121(x) or cos^{-1}(x) (read as \"cosine inverse of x\").\\n' +\n      '\\n' +\n      '- The notation sin\u22121(x) is usually preferred over cos\u22121(x) since it relates more directly to the unit circle definition of cosine. sin\u22121(x) gives the angle whose sine equals x.\\n' +\n      '\\n' +\n      '- The arcsine function is one-to-one on the domain [-1, 1]. This means every output angle maps back to exactly one input ratio x. This one-to-one mapping is what makes it the mathematical inverse of cosine.\\n' +\n      '\\n' +\n      'So in summary, arcsine or inverse sine, written as sin\u22121(x) or sin^{-1}(x), gives you the angle whose cosine evaluates to the input x, undoing the cosine function. It is used throughout trigonometry and calculus.',\n    additional_kwargs: {\n      id: 'msg_01PYRhpoUudApdJvxug6R13W',\n      type: 'message',\n      role: 'assistant',\n      model: 'claude-3-sonnet-20240229',\n      stop_reason: 'end_turn',\n      stop_sequence: null\n    }\n  }\n*/\n"})}),"\n",(0,t.jsx)(n.admonition,{type:"tip",children:(0,t.jsx)(n.p,{children:(0,t.jsx)(n.a,{href:"https://smith.langchain.com/public/50377a89-d0b8-413b-8cd7-8e6618835e00/r",children:"Langsmith trace"})})}),"\n",(0,t.jsx)(n.p,{children:'Looking at the Langsmith trace for the second call, we can see that when constructing the prompt, a "history" variable has been injected which is a list of two messages (our first input and first output).'})]})}function d(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(l,{...e})}):l(e)}}}]);